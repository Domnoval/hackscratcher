name: Scheduled Lottery Data Scraping

on:
  # Run 3 times per day (9 AM, 1 PM, 6 PM Central Time)
  schedule:
    - cron: '0 14 * * *'  # 9 AM CT (2 PM UTC)
    - cron: '0 18 * * *'  # 1 PM CT (6 PM UTC)
    - cron: '0 23 * * *'  # 6 PM CT (11 PM UTC)

  # Allow manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  scrape-minnesota:
    name: Scrape Minnesota Lottery Data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Minnesota game scraper
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
        run: npm run scrape
        continue-on-error: true

      - name: Run Minnesota prize scraper
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
        run: npm run scrape:prizes:mn
        continue-on-error: true

      - name: Check for scraping errors
        run: |
          if [ -f scrape-errors.log ]; then
            echo "‚ö†Ô∏è Scraping completed with errors:"
            cat scrape-errors.log
            exit 0  # Don't fail the build on scraping errors
          else
            echo "‚úÖ Scraping completed successfully"
          fi

      - name: Create scrape timestamp
        run: |
          echo "Last scraped: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > last-scrape.txt
          echo "Workflow run: ${{ github.run_number }}" >> last-scrape.txt

      - name: Upload scrape logs (if any errors)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scrape-logs-${{ github.run_number }}
          path: |
            *.log
            *.html
            *.png
          retention-days: 7

  scrape-florida:
    name: Scrape Florida Lottery Data
    runs-on: ubuntu-latest
    needs: scrape-minnesota

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Florida prize scraper
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
        run: npm run scrape:prizes:fl
        continue-on-error: true

      - name: Upload scrape logs (if any errors)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scrape-logs-florida-${{ github.run_number }}
          path: |
            *.log
            *.html
            *.png
          retention-days: 7

  notify-completion:
    name: Notify Scraping Status
    runs-on: ubuntu-latest
    needs: [scrape-minnesota, scrape-florida]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "üé∞ Lottery Data Scraping Summary"
          echo "================================"
          echo "Minnesota: ${{ needs.scrape-minnesota.result }}"
          echo "Florida: ${{ needs.scrape-florida.result }}"
          echo "Timestamp: $(date -u)"
          echo ""
          echo "‚ÑπÔ∏è Data is now fresh and available for users!"
