name: PR Preview Build

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18.x'

jobs:
  # Job 1: Build preview APK for PRs
  build-preview:
    name: Build Preview APK
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Build preview APK
        id: build
        run: |
          echo "Starting EAS build for preview..."
          eas build --platform android --profile preview --non-interactive --no-wait
          echo "build_started=true" >> $GITHUB_OUTPUT
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“ Comment build status on PR
        if: steps.build.outputs.build_started == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const buildUrl = 'https://expo.dev/accounts/mm444/projects/scratch-oracle-app/builds';

            const comment = `## ğŸš€ Preview Build Started!

            A preview APK is being built for this PR.

            **ğŸ“± Build Details:**
            - Platform: Android
            - Profile: Preview
            - Branch: \`${context.payload.pull_request.head.ref}\`
            - Commit: \`${context.sha.substring(0, 7)}\`

            **ğŸ”— Track Progress:**
            [View build on EAS Dashboard](${buildUrl})

            **â±ï¸ Build Time:** Typically 10-15 minutes

            **ğŸ“¥ Installation:**
            Once the build completes, you can:
            1. Visit the [EAS Dashboard](${buildUrl})
            2. Find the latest build
            3. Download the APK
            4. Install on your Android device

            **Note:** You may need to enable "Install from Unknown Sources" in your device settings.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ”” Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Preview build failed to start! Check the workflow logs for details.\n\n[View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });

  # Job 2: PR information and guidelines
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: ğŸ“ Post PR guidelines
        uses: actions/github-script@v7
        with:
          script: |
            const guidelines = `## ğŸ‘‹ Thanks for your PR!

            ### âœ… Automated Checks
            This PR will automatically run:
            - TypeScript type checking
            - Unit tests with coverage
            - Security scans
            - Preview APK build

            ### ğŸ“‹ Before Merging
            Please ensure:
            - [ ] Tests pass
            - [ ] Code coverage meets threshold (80%)
            - [ ] TypeScript compiles without errors
            - [ ] Preview APK tested on a physical device
            - [ ] No security vulnerabilities introduced

            ### ğŸš€ After Approval
            When this PR is merged to \`main\`:
            - An OTA update will be automatically published
            - Existing users will receive the update
            - No new APK/AAB build required (unless native changes)

            ### ğŸ“± Testing Preview Build
            A preview APK is being built. Once ready:
            1. Download from [EAS Dashboard](https://expo.dev/accounts/mm444/projects/scratch-oracle-app/builds)
            2. Install on Android device
            3. Test thoroughly
            4. Report any issues in this PR

            ---

            *Need help? Check out the [CI/CD Setup Guide](../CI_CD_SETUP.md)*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: guidelines
            });

  # Job 3: Size analysis
  analyze-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Analyze bundle size
        run: |
          echo "## ğŸ“¦ Bundle Size Analysis" > size-report.txt
          echo "" >> size-report.txt
          du -sh node_modules >> size-report.txt
          echo "" >> size-report.txt
          echo "Top 10 largest dependencies:" >> size-report.txt
          du -sh node_modules/* | sort -rh | head -10 >> size-report.txt

      - name: ğŸ“ Post size analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('size-report.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '```\n' + report + '\n```'
            });
